@model IEnumerable<Pos.Models.Sale>
@using System.Globalization;

@{
    ViewData["Title"] = "Admin – Sales";
    var total = (int?)ViewBag.Total ?? Model.Count();
    var southAfricaCulture = CultureInfo.GetCultureInfo("en-ZA");
    decimal grandTotal = Model.Sum(s => (s.Lines?.Sum(l => l.Quantity * l.UnitPrice) ?? 0m));
    var page = (int?)ViewBag.Page ?? 1;
    var pageSize = (int?)ViewBag.PageSize ?? 25;
    var q = (string?)ViewBag.Query;
    var startDateVal = (string?)ViewBag.StartDate;
    var endDateVal   = (string?)ViewBag.EndDate;
}

<h1>Sales</h1>


@if (TempData["Success"] is string ok)
{
  <div class="alert alert-success">@ok</div>
}

<form method="get" class="mb-3 row g-2 align-items-end">
  <div class="col-sm-4">
    <label class="form-label">Search</label>
    <input name="q" value="@q" class="form-control text-white bg-dark placeholder-glows" placeholder="Search by salesperson or item..." />
  </div>
    @if (User.IsInRole("Admin"))
        {
            <div class="col-sm-2">
                <label class="form-label">Start date</label>
                <input type="date" name="startDate" value="@startDateVal" class="form-control text-white bg-dark" />
            </div>
            <div class="col-sm-2">
                <label class="form-label">End date</label>
                <input type="date" name="endDate" value="@endDateVal" class="form-control text-white bg-dark" />
            </div>
        }
        <div class="col-sm-3 d-flex gap-2">
    <button class="btn btn-primary flex-grow-1">Apply</button>
    <a class="btn btn-outline-light text-white" asp-action="Index">Clear Filters</a>
        <a class="btn btn-outline-light text-white"
           asp-action="ExportSalesPdf"
           asp-route-q="@q"
           asp-route-startDate="@startDateVal"
           asp-route-endDate="@endDateVal"
           asp-route-pageSize="@pageSize">
            Print
        </a>
  </div>

</form>



<table class="table table-striped align-middle table-dark">
  <thead>
    <tr>
      <th>#</th>
      <th>Date</th>
      <th>Sales Person</th>
      <th>Items</th>
      <th>Total</th>
      @if (User.IsInRole("Admin")){
      <th>Actions</th>
            }
    </tr>
  </thead>
  <tbody>
@foreach (var s in Model)
{
    var totalAmt = s.Lines?.Sum(l => l.Quantity * l.UnitPrice) ?? 0m;
    <tr>
      <td>@s.Id</td>
      <td>@s.SaleDate.ToString("yyyy-MM-dd HH:mm")</td>
      <td>@s.SalesPerson</td>
      <td>
        @foreach (var l in s.Lines)
        {
          <div>@l.Quantity × @l.Service?.Name (@l.UnitPrice.ToString("C", southAfricaCulture))</div>
        }
      </td>
      <td>@totalAmt.ToString("C", southAfricaCulture)</td>
      @if (User.IsInRole("Admin")){
      <td class="text-nowrap">
        <a class="btn btn-sm btn-outline-primary" asp-controller="Admin" asp-action="EditSale" asp-route-id="@s.Id">Edit</a>
        <form asp-controller="Admin" asp-action="DeleteSale" asp-route-id="@s.Id" method="post" class="d-inline">
          <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete sale #@s.Id?');">Delete</button>
        </form>
      </td>
      }
    </tr>
}
  </tbody>
  <tfoot>
    <tr>
      <td colspan="4" class="text-end fw-bold">Total of current sales:</td>
      <td class="fw-bold">@grandTotal.ToString("C", southAfricaCulture)</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<div class="d-flex justify-content-between align-items-center">
  <div>
    @if (page > 1)
    {
      <a class="btn btn-sm btn-light"
         asp-action="Index"
         asp-route-q="@q"
         asp-route-startDate="@startDateVal"
         asp-route-endDate="@endDateVal"
         asp-route-page="@(page-1)"
         asp-route-pageSize="@pageSize">&laquo; Prev</a>
    }
    <a class="btn btn-sm btn-light"
       asp-action="Index"
       asp-route-q="@q"
       asp-route-startDate="@startDateVal"
       asp-route-endDate="@endDateVal"
       asp-route-page="@(page+1)"
       asp-route-pageSize="@pageSize">Next &raquo;</a>
  </div>
</div>
