@model Pos.Models.AdminSaleEditVm
@{
    ViewData["Title"] = $"Edit Sale #{Model.Id}";
    var southAfricaCulture = System.Globalization.CultureInfo.GetCultureInfo("en-ZA");
}

<h1>@ViewData["Title"]</h1>

@if (TempData["Success"] is string ok)
{
  <div class="alert alert-success">@ok</div>
}

<form asp-action="EditSale" method="post">
  <input type="hidden" asp-for="Id"/>

  <div class="mb-1">
    <label asp-for="SalesPerson" class="form-label"></label>
    <input asp-for="SalesPerson" class="form-control text-white bg-dark" />
    <span asp-validation-for="SalesPerson" class="text-danger"></span>
  </div>

  <div class="mb-3">
    <label asp-for="SaleDate" class="form-label"></label>
    <input asp-for="SaleDate" type="datetime-local" class="form-control bg-dark text-white" />
  </div>

  <h4>Lines</h4>
  <table class="table align-middle table-dark">
    <thead>
      <tr>
        <th style="width:35%">Service</th>
        <th style="width:15%">Qty</th>
        <th style="width:20%">Unit Price</th>
        <th style="width:20%">Line Total</th>
        <th style="width:10%"></th>
      </tr>
    </thead>
    <tbody>
            @for (int i = 0; i < Model.Lines.Count; i++)
            {
                <tr>
                    <td>
                        <input type="hidden" asp-for="Lines[@i].Id" />
                        <select asp-for="Lines[@i].ServiceId" class="form-select bg-dark text-white"
                                asp-items="@(new SelectList(Model.Services, "Id", "Name", Model.Lines[i].ServiceId))">
                            <option value="">-- select service --</option>
                        </select>
                    </td>
                    <td>
                        <input asp-for="Lines[@i].Quantity" class="form-control js-qty bg-dark text-white" type="number" step="1" min="0" />
                    </td>
                    <td>
                        <input asp-for="Lines[@i].UnitPrice" class="form-control js-price bg-dark text-white" type="number" step="0.01" min="0" />
                    </td>
                    <td>
                        <span class="js-line-total">@((Model.Lines[i].Quantity * Model.Lines[i].UnitPrice).ToString("C" , southAfricaCulture))</span>
                    </td>
                    <td>
                        <button name="Command" value="RemoveLine" class="btn btn-sm btn-outline-danger"
                                formaction="@Url.Action("EditSale", new { id = Model.Id })" formmethod="post">
                            Remove
                        </button>
                        <input type="hidden" name="CommandIndex" value="@i" />
                    </td>
                </tr>
            }
    </tbody>
  </table>

  <button name="Command" value="AddLine" class="btn btn-sm btn-outline-secondary"
          formaction="@Url.Action("EditSale", new { id = Model.Id })"
          formmethod="post">
    + Add line
  </button>

  <div class="mt-3"><strong>Grand Total:</strong> @Model.GrandTotal.ToString("C", southAfricaCulture)</div>

  <div class="mt-4 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a asp-controller="Admin" asp-action="Index" class="btn btn-secondary">Back</a>
  </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const fmt = new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' });

        function recalcRow(tr) {
          const qty   = parseFloat(tr.querySelector('.js-qty')?.value || '0');
          const price = parseFloat(tr.querySelector('.js-price')?.value || '0');
          const total = (isNaN(qty) || isNaN(price)) ? 0 : qty * price;
          const cell  = tr.querySelector('.js-line-total');
          if (cell) cell.textContent = fmt.format(total);
          return total;
        }

        function recalcAll() {
          let grand = 0;
          document.querySelectorAll('table tbody tr').forEach(tr => grand += recalcRow(tr));
          const gt = document.querySelector('#js-grand-total');
          if (gt) gt.textContent = fmt.format(grand);
        }

        document.addEventListener('input', (e) => {
          if (e.target.closest('.js-qty') || e.target.closest('.js-price')) {
            const tr = e.target.closest('tr');
            recalcRow(tr);
            recalcAll();
          }
        });

        // initial
        recalcAll();
    </script>
}
